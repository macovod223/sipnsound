generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                String           @id @default(uuid())
  username          String           @unique
  email             String           @unique
  passwordHash      String           @map("password_hash")
  displayName       String?          @map("display_name")
  avatarUrl         String?          @map("avatar_url")
  createdAt         DateTime         @default(now()) @map("created_at")
  updatedAt         DateTime         @updatedAt @map("updated_at")
  isVerified        Boolean          @default(false) @map("is_verified")
  role              UserRole         @default(USER)
  subscription_type SubscriptionType @default(FREE)
  following         Following[]
  likedTracks       LikedTrack[]
  playHistory       PlayHistory[]
  playlists         Playlist[]
  queue             QueueTrack[]
  uploadedTracks    Track[]          @relation("UploadedBy")

  @@map("users")
}

model Artist {
  id               String      @id @default(uuid())
  name             String      @unique
  bio              String?
  imageUrl         String?     @map("image_url")
  imagePath        String?     @map("image_path")
  verified         Boolean     @default(false)
  monthlyListeners Int         @default(0) @map("monthly_listeners")
  createdAt        DateTime    @default(now()) @map("created_at")
  updatedAt        DateTime    @updatedAt @map("updated_at")
  albums           Album[]
  followers        Following[]
  tracks           Track[]

  @@map("artists")
}

model Album {
  id        String   @id @default(uuid())
  title     String
  year      Int
  type      String   @default("album")
  coverUrl  String?  @map("cover_url")
  coverPath String?  @map("cover_path")
  artistId  String   @map("artist_id")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  artist    Artist   @relation(fields: [artistId], references: [id])
  tracks    Track[]

  @@map("albums")
}

model Track {
  id           String          @id @default(uuid())
  title        String
  duration     Int
  audioUrl     String          @map("audio_url")
  audioPath    String?         @map("audio_path")
  coverUrl     String?         @map("cover_url")
  coverPath    String?         @map("cover_path")
  lyricsPath   String?         @map("lyrics_path")
  lyrics       Json?
  playsCount   Int             @default(0) @map("plays_count")
  uploadedById String?         @map("uploaded_by")
  artistId     String          @map("artist_id")
  albumId      String?         @map("album_id")
  createdAt    DateTime        @default(now()) @map("created_at")
  updatedAt    DateTime        @updatedAt @map("updated_at")
  genreId      String?         @map("genre_id")
  isExplicit   Boolean         @default(false) @map("is_explicit")
  isPublished  Boolean         @default(true) @map("is_published")
  likedBy      LikedTrack[]
  playHistory  PlayHistory[]
  playlists    PlaylistTrack[]
  queueTracks  QueueTrack[]
  album        Album?          @relation(fields: [albumId], references: [id])
  artist       Artist          @relation(fields: [artistId], references: [id], onDelete: Cascade)
  genre        Genre?          @relation(fields: [genreId], references: [id])
  uploadedBy   User?           @relation("UploadedBy", fields: [uploadedById], references: [id])

  @@index([artistId])
  @@index([albumId])
  @@index([genreId])
  @@index([uploadedById])
  @@index([playsCount])
  @@map("tracks")
}

model Playlist {
  id          String          @id @default(uuid())
  title       String
  description String?
  coverUrl    String?         @map("cover_url")
  isPublic    Boolean         @default(true) @map("is_public")
  userId      String          @map("user_id")
  createdAt   DateTime        @default(now()) @map("created_at")
  updatedAt   DateTime        @updatedAt @map("updated_at")
  tracks      PlaylistTrack[]
  user        User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("playlists")
}

model PlaylistTrack {
  id         String   @id @default(uuid())
  playlistId String   @map("playlist_id")
  trackId    String   @map("track_id")
  position   Int
  addedAt    DateTime @default(now()) @map("added_at")
  playlist   Playlist @relation(fields: [playlistId], references: [id], onDelete: Cascade)
  track      Track    @relation(fields: [trackId], references: [id], onDelete: Cascade)

  @@unique([playlistId, trackId])
  @@map("playlist_tracks")
}

model LikedTrack {
  userId  String   @map("user_id")
  trackId String   @map("track_id")
  likedAt DateTime @default(now()) @map("liked_at")
  track   Track    @relation(fields: [trackId], references: [id], onDelete: Cascade)
  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([userId, trackId])
  @@map("liked_tracks")
}

model PlayHistory {
  id       String   @id @default(uuid())
  userId   String   @map("user_id")
  trackId  String   @map("track_id")
  playedAt DateTime @default(now()) @map("played_at")
  track    Track    @relation(fields: [trackId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([playedAt])
  @@map("play_history")
}

model Genre {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  imageUrl    String?  @map("image_url")
  color       String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  tracks      Track[]

  @@map("genres")
}

model Following {
  userId     String   @map("user_id")
  artistId   String   @map("artist_id")
  followedAt DateTime @default(now()) @map("followed_at")
  artist     Artist   @relation(fields: [artistId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([userId, artistId])
  @@map("following")
}

model QueueTrack {
  id       String   @id @default(uuid())
  userId   String   @map("user_id")
  trackId  String   @map("track_id")
  position Int
  addedAt  DateTime @default(now()) @map("added_at")
  track    Track    @relation(fields: [trackId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("queue_tracks")
}

enum UserRole {
  USER
  ARTIST
  ADMIN
}

enum SubscriptionType {
  FREE
  PREMIUM
  FAMILY
}
